name: "Environments version manifest"

# Gets the following content from the `VERSION` manifest:
# 1. current version: the target version for the Terraform plan and apply.
# 2. previous version: the previously deployed Terraform version.

on:
  pull_request:
    branches: [main]
#  workflow_call:
#    outputs:
#      previous:
#        description: "The previous contents of the VERSION manifest"
#        value: ${{ jobs.version-manifest.outputs.previous }}
#      current:
#        description: "The current contents of the VERSION manifest"
#        value: ${{ jobs.version-manifest.outputs.current }}

jobs:
  environments-manifest:
    runs-on: ubuntu-latest
    outputs:
      PROD_WORDPRESS: ${{ steps.versions.outputs.PROD_WORDPRESS }}
      STAG_WORDPRESS: ${{ steps.versions.outputs.STAG_WORDPRESS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Versions
        id: versions
        run: |
          PROD_WORDPRESS=$(yq '.production.wordpress' < ./infrastructure/environments.yml)
          STAG_WORDPRESS=$(yq '.production.apache' < ./infrastructure/environments.yml)
          echo "Production Wordpress: $PROD_WORDPRESS"
          echo "Production Apache: $STAG_WORDPRESS"
          echo "::set-output name=PROD_WORDPRESS::${PROD_WORDPRESS}"
          echo "::set-output name=STAG_WORDPRESS::${STAG_WORDPRESS}"
      - name: Previous versions
        id: previous
        run: |
          PREV_SHA="$(git show -2 --pretty=format:"%h" --no-patch infrastructure/environments.yml | tail -n 1)"
          PREV_ENVIRONMENTS_YML="$(git show ${PREV_SHA}:infrastructure/environments.yml)"
          PROD_WORDPRESS=$(echo $PREV_ENVIRONMENTS_YML | yq '.production.wordpress' -)
          STAG_WORDPRESS=$(echo $PREV_ENVIRONMENTS_YML | yq '.staging.wordpress' -)
          echo "Previous production worpdress: $PROD_WORDPRESS"
          echo "Previous staging wordpress: $STAG_WORDPRESS"

#
#          echo "PREV_VERSION=infrastructure/${PREV_VERSION}"
#                    echo "CURR_VERSION=infrastructure/${CURR_VERSION}"
#                    echo "::set-output name=previous::v${PREV_VERSION}"
#                    echo "::set-output name=current::v${CURR_VERSION}"
#  read-versions:
#    needs: environments-manifest
#    runs-on: ubuntu-latest
#    env:
#      WORDPRESS: ${{ needs.environments-manifest.outputs.productionWordpress }}
#    steps:
#      - name: Versions
#        run: |
#          echo "WORDPRESS: ${WORDPRESS}"
